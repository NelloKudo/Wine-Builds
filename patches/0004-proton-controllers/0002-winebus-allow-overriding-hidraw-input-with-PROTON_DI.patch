From d6c9b21d5a913dd439503a14cc0a75b8f513bf55 Mon Sep 17 00:00:00 2001
From: NelloKudo <marshnelloosu@gmail.com>
Date: Mon, 15 Sep 2025 15:44:20 +0200
Subject: [PATCH] winebus: allow overriding hidraw/input with
 PROTON_DISABLE_HIDRAW etc.

Attempt at providing the same behavior as Proton where both PROTON_DISABLE_HIDRAW
and PROTON_PREFER_SDL disable hidraw.

Also introduced a PROTON_DISABLE_INPUT to set 'DisableInput' to 1, has been done in
the latest wine-tkg releases and might prove helpful to someone.
---
 dlls/winebus.sys/main.c      | 30 ++++++++++++++++++++++++++++++
 programs/services/services.c | 26 +++++++++++++++++++-------
 2 files changed, 49 insertions(+), 7 deletions(-)

diff --git a/dlls/winebus.sys/main.c b/dlls/winebus.sys/main.c
index fc4ef81985f..2f9e2887b25 100644
--- a/dlls/winebus.sys/main.c
+++ b/dlls/winebus.sys/main.c
@@ -494,6 +494,36 @@ static DWORD check_bus_option(const WCHAR *option, DWORD default_value)
     KEY_VALUE_PARTIAL_INFORMATION *info = (KEY_VALUE_PARTIAL_INFORMATION *)buffer;
     UNICODE_STRING str;
     DWORD size;
+    const char *env;
+
+    /* Allow disabling hidraw/input using Proton's known env. vars, besides registry. */
+    /* based on preserved env. vars in service_start_process() */
+    if (!wcsicmp(option, L"DisableHidraw"))
+    {
+        env = getenv("PROTON_DISABLE_HIDRAW");
+        if (!env) env = getenv("PROTON_PREFER_SDL");
+        if (env && atoi(env))
+        {
+            FIXME("Toggle detected, disabling hidraw..\n");
+            return (DWORD)1;
+        }
+
+        env = getenv("PROTON_ENABLE_HIDRAW");
+        if (env && atoi(env))
+        {
+            FIXME("Toggle detected, enabling hidraw..\n");
+            return (DWORD)0;
+        }
+    }
+    else if (!wcsicmp(option, L"DisableInput"))
+    {
+        env = getenv("PROTON_DISABLE_INPUT");
+        if (env && atoi(env))
+        {
+            FIXME("Toggle detected, disabling input..\n");
+            return (DWORD)1;
+        }
+    }
 
     /* @@ Wine registry key: HKLM\System\CurrentControlSet\Services\WineBus */
     RtlInitUnicodeString(&str, option);
diff --git a/programs/services/services.c b/programs/services/services.c
index dff3cd60040..87ac399989c 100644
--- a/programs/services/services.c
+++ b/programs/services/services.c
@@ -1030,15 +1030,27 @@ found:
 
     if (!environment && OpenProcessToken(GetCurrentProcess(), TOKEN_QUERY | TOKEN_DUPLICATE, &token))
     {
-        WCHAR val[16];
-        CreateEnvironmentBlock(&environment, token, FALSE);
-        if (GetEnvironmentVariableW( L"WINEBOOTSTRAPMODE", val, ARRAY_SIZE(val) ))
+        static const WCHAR *preserve[] =
         {
-            UNICODE_STRING name = RTL_CONSTANT_STRING(L"WINEBOOTSTRAPMODE");
-            UNICODE_STRING value;
+            L"WINEBOOTSTRAPMODE",
+            L"WINEBUSCONFIG",
+            L"PROTON_DISABLE_HIDRAW",
+            L"PROTON_ENABLE_HIDRAW",
+            L"PROTON_PREFER_SDL",
+            L"PROTON_DISABLE_INPUT"
+        };
+        WCHAR val[1024];
 
-            RtlInitUnicodeString( &value, val );
-            RtlSetEnvironmentVariable( (WCHAR **)&environment, &name, &value );
+        CreateEnvironmentBlock(&environment, token, FALSE);
+        for (size_t i = 0; i < ARRAY_SIZE(preserve); i++)
+        {
+            if (GetEnvironmentVariableW( preserve[i], val, ARRAY_SIZE(val) ))
+            {
+                UNICODE_STRING value, name;
+                RtlInitUnicodeString( &name, preserve[i] );
+                RtlInitUnicodeString( &value, val );
+                RtlSetEnvironmentVariable( (WCHAR **)&environment, &name, &value );
+            }
         }
         CloseHandle(token);
     }
-- 
2.51.0

