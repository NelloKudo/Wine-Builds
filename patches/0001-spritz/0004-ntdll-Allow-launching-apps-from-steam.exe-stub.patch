From 5ab29dfa545d0bcc919e71116aa147f4300a4ed7 Mon Sep 17 00:00:00 2001
From: NelloKudo <marshnelloosu@gmail.com>
Date: Tue, 7 Oct 2025 13:33:38 +0200
Subject: [PATCH] ntdll: Allow launching apps from steam.exe stub

Some games need to be launched from Proton's stub steam.exe to allow
being launched on Linux and related systems: this allows doing so without
any Proton script, but straight up from Wine.
---
 dlls/ntdll/unix/env.c          | 47 +++++++++++++++++++++++++++++-----
 dlls/ntdll/unix/loader.c       | 26 +++++++++++++++++++
 dlls/ntdll/unix/unix_private.h |  1 +
 3 files changed, 67 insertions(+), 7 deletions(-)

diff --git a/dlls/ntdll/unix/env.c b/dlls/ntdll/unix/env.c
index 2cb8c59f6f3..37a37386b18 100644
--- a/dlls/ntdll/unix/env.c
+++ b/dlls/ntdll/unix/env.c
@@ -1959,6 +1959,24 @@ static void init_peb( RTL_USER_PROCESS_PARAMETERS *params, void *module )
 }
 
 
+/* HACK: Check for conditions to use the Steam stub */
+static BOOL use_steam_stub()
+{
+    static volatile char cache = -1;
+    if (cache == -1)
+    {
+        const char *env = getenv("WINE_ENABLE_STEAM_STUB");
+        
+        if (env && atoi(env))
+            cache = TRUE;
+        else
+            cache = FALSE;
+    }
+
+    return cache;
+}
+
+
 /*************************************************************************
  *		build_initial_params
  *
@@ -1974,6 +1992,7 @@ static RTL_USER_PROCESS_PARAMETERS *build_initial_params( void **module )
     WCHAR *env = get_initial_environment( &env_pos, &env_size );
     WCHAR *curdir = get_initial_directory();
     NTSTATUS status;
+    BOOL launch_with_steam = use_steam_stub();
 
     if (NtCurrentTeb64()) NtCurrentTeb64()->TlsSlots[WOW64_TLS_FILESYSREDIR] = TRUE;
 
@@ -2010,18 +2029,32 @@ static RTL_USER_PROCESS_PARAMETERS *build_initial_params( void **module )
         }
     }
 
-    if (status)  /* try launching it through start.exe */
+    /* check if we should launch from the Steam stub */
+    /* launch using the steam wrapper */
+    if (launch_with_steam)
     {
-        static const char *args[] = { "start.exe", "/exec" };
+        static const char *args[] = { "steam.exe" };
         free( image );
         if (*module) NtUnmapViewOfSection( GetCurrentProcess(), *module );
-        load_start_exe( &image, module );
-        prepend_argv( args, 2 );
+        load_steam_exe( &image, module );
+        prepend_argv( args, 1 );
     }
-    else
+    /* or fallback to upstream behavior */
+    else 
     {
-        rebuild_argv();
-        if (NtCurrentTeb64()) NtCurrentTeb64()->TlsSlots[WOW64_TLS_FILESYSREDIR] = FALSE;
+        if (status)  /* try launching it through start.exe */
+        {
+            static const char *args[] = { "start.exe", "/exec" };
+            free( image );
+            if (*module) NtUnmapViewOfSection( GetCurrentProcess(), *module );
+            load_start_exe( &image, module );
+            prepend_argv( args, 2 );
+        }
+        else
+        {
+            rebuild_argv();
+            if (NtCurrentTeb64()) NtCurrentTeb64()->TlsSlots[WOW64_TLS_FILESYSREDIR] = FALSE;
+        }
     }
 
     main_wargv = build_wargv( get_dos_path( image ));
diff --git a/dlls/ntdll/unix/loader.c b/dlls/ntdll/unix/loader.c
index b70c24684ef..6bed602ab33 100644
--- a/dlls/ntdll/unix/loader.c
+++ b/dlls/ntdll/unix/loader.c
@@ -1643,6 +1643,32 @@ NTSTATUS load_start_exe( WCHAR **image, void **module )
     return status;
 }
 
+/***********************************************************************
+ *           load_steam_exe
+ *
+ * Load steam.exe as main image.
+ * Adapted from load_start_exe.
+ */
+NTSTATUS load_steam_exe( WCHAR **image, void **module )
+{
+    static const WCHAR startW[] = {'s','t','e','a','m','.','e','x','e',0};
+    UNICODE_STRING nt_name;
+    unsigned int status;
+    SIZE_T size;
+
+    *image = malloc( sizeof("\\??\\C:\\windows\\system32\\steam.exe") * sizeof(WCHAR) );
+    wcscpy( *image, get_machine_wow64_dir( current_machine ));
+    wcscat( *image, startW );
+    init_unicode_string( &nt_name, *image );
+    status = find_builtin_dll( &nt_name, module, &size, &main_image_info, 0, 0, current_machine, 0, FALSE );
+    if (!NT_SUCCESS(status))
+    {
+        MESSAGE( "wine: failed to load steam.exe: %x\n", status );
+        NtTerminateProcess( GetCurrentProcess(), status );
+    }
+    MESSAGE("wine: launching from steam.exe stub!\n");
+    return status;
+}
 
 /***********************************************************************
  *           load_ntdll_functions
diff --git a/dlls/ntdll/unix/unix_private.h b/dlls/ntdll/unix/unix_private.h
index c60eb4c4e0f..8ba0b93d827 100644
--- a/dlls/ntdll/unix/unix_private.h
+++ b/dlls/ntdll/unix/unix_private.h
@@ -221,6 +221,7 @@ extern BOOL is_builtin_path( const UNICODE_STRING *path, WORD *machine );
 extern NTSTATUS load_main_exe( const WCHAR *name, const char *unix_name, const WCHAR *curdir,
                                USHORT load_machine, WCHAR **image, void **module );
 extern NTSTATUS load_start_exe( WCHAR **image, void **module );
+extern NTSTATUS load_steam_exe( WCHAR **image, void **module );
 extern ULONG_PTR redirect_arm64ec_rva( void *module, ULONG_PTR rva, const IMAGE_ARM64EC_METADATA *metadata );
 extern void start_server( BOOL debug );
 
-- 
2.51.0

