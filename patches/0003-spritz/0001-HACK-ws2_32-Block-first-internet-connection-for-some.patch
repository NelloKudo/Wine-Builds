From 6684c3435e394bb4e698fc573041ab9686396d5b Mon Sep 17 00:00:00 2001
From: NelloKudo <marshnelloosu@gmail.com>
Date: Thu, 14 Aug 2025 14:18:26 +0200
Subject: [PATCH] HACK: ws2_32: Block first internet connection for some games

Fixes launch issues/high CPU usage, can be disabled in-case of
various issues with WINE_DISABLE_DISCONNECT=1.
---
 dlls/ws2_32/socket.c | 36 ++++++++++++++++++++++++++++++++++++
 1 file changed, 36 insertions(+)

diff --git a/dlls/ws2_32/socket.c b/dlls/ws2_32/socket.c
index d4223e93bd1..5538069980a 100644
--- a/dlls/ws2_32/socket.c
+++ b/dlls/ws2_32/socket.c
@@ -1262,6 +1262,30 @@ int WINAPI closesocket( SOCKET s )
     return 0;
 }
 
+static BOOL is_mhy(void)
+{
+    static volatile char cache = -1;
+    BOOL ret = cache;
+    if (ret == -1)
+    {
+        const WCHAR *p, *name = NtCurrentTeb()->Peb->ProcessParameters->ImagePathName.Buffer;
+        const char *env = getenv("WINE_ENABLE_DISCONNECT");
+        
+        /* Check for known games */ 
+        if ((p = wcsrchr(name, '/')))
+            name = p + 1;
+        if ((p = wcsrchr(name, '\\')))
+            name = p + 1;
+        ret = (!wcsicmp(name, L"StarRail.exe") ||
+               !wcsicmp(name, L"ZenlessZoneZero.exe"));
+        cache = ret;
+
+        /* Also check by env. var */
+        if (env && atoi(env))
+            ret = TRUE;
+    }
+    return ret;
+}
 
 /***********************************************************************
  *      connect   (ws2_32.4)
@@ -1272,6 +1296,18 @@ int WINAPI connect( SOCKET s, const struct sockaddr *addr, int len )
     IO_STATUS_BLOCK io;
     HANDLE sync_event;
     NTSTATUS status;
+    static int count = 0;
+    const char* env = getenv("WINE_DISABLE_DISCONNECT");
+
+    // HACK: Block first connection for mhy games
+    // can be disabled with WINE_DISABLE_DISCONNECT=1
+    if (!count && !(env && atoi(env) == 1) && is_mhy())
+    {
+        FIXME("Toggle detected, disabling first connection..\n");
+        count = 1;
+        WSASetLastError(WSAECONNREFUSED);
+        return SOCKET_ERROR;
+    }
 
     TRACE( "socket %#Ix, addr %s, len %d\n", s, debugstr_sockaddr(addr), len );
 
-- 
2.51.0

